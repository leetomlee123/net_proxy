package proxy

import (
	"crypto/tls"
	"crypto/x509"

	"gopkg.in/elazarl/goproxy.v1"
)

var caCert = `-----BEGIN CERTIFICATE-----
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
D308
-----END CERTIFICATE-----
`
var caKey = `-----BEGIN PRIVATE KEY-----
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
VltFkpgJYQD/xhkxlaPzGeCveyKtppQ=
-----END PRIVATE KEY-----
`

func setCA(caCert, caKey []byte) error {
	goproxyCa, err := tls.X509KeyPair(caCert, caKey)
	if err != nil {
		return err
	}
	if goproxyCa.Leaf, err = x509.ParseCertificate(goproxyCa.Certificate[0]); err != nil {
		return err
	}
	goproxy.GoproxyCa = goproxyCa
	goproxy.OkConnect = &goproxy.ConnectAction{Action: goproxy.ConnectAccept, TLSConfig: goproxy.TLSConfigFromCA(&goproxyCa)}
	goproxy.MitmConnect = &goproxy.ConnectAction{Action: goproxy.ConnectMitm, TLSConfig: goproxy.TLSConfigFromCA(&goproxyCa)}
	goproxy.HTTPMitmConnect = &goproxy.ConnectAction{Action: goproxy.ConnectHTTPMitm, TLSConfig: goproxy.TLSConfigFromCA(&goproxyCa)}
	goproxy.RejectConnect = &goproxy.ConnectAction{Action: goproxy.ConnectReject, TLSConfig: goproxy.TLSConfigFromCA(&goproxyCa)}
	return nil
}
